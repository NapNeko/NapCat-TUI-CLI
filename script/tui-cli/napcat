#!/bin/bash

#  åŸºæœ¬é…ç½® 
# ç¡®å®šç›®æ ‡ç”¨æˆ·å’Œå…¶ä¸»ç›®å½•
TARGET_USER="$USER"
TARGET_USER_HOME="$HOME"

# åŸºäºç›®æ ‡ç”¨æˆ·ä¸»ç›®å½•å®šä¹‰è·¯å¾„
INSTALL_BASE_DIR="$TARGET_USER_HOME/Napcat"
RUN_DIR="$INSTALL_BASE_DIR/run"
LOG_DIR="$INSTALL_BASE_DIR/log"
NAPCAT_DIR="$INSTALL_BASE_DIR/opt/QQ/resources/app/app_launcher/napcat"
CONFIG_DIR="$NAPCAT_DIR/config"

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
BOOT_SCRIPT="$SCRIPT_DIR/_napcat_Boot"
CONFIG_SCRIPT="$SCRIPT_DIR/_napcat_Config"
OLD_CLI_SCRIPT="$SCRIPT_DIR/_napcat_old"
INIT_FLAG="$RUN_DIR/napcat_shell.flag" # é¦–æ¬¡è¿è¡Œæ ‡è®°æ–‡ä»¶
INSTALL_SCRIPT_URL="https://nclatest.znin.net/NapNeko/NapCat-Installer/main/script/install.sh"
INSTALL_SCRIPT_LOCAL="napcat_install.sh" # æœ¬åœ°å®‰è£…è„šæœ¬æ–‡ä»¶å



if [[ "$#" -gt 0 ]]; then
    if [[ -f "$OLD_CLI_SCRIPT" ]] && [[ -x "$OLD_CLI_SCRIPT" ]]; then
        # _napcat_old è„šæœ¬åº”è‡ªè¡Œå¤„ç†å…¶å¯èƒ½éœ€è¦çš„ root æƒé™æ£€æŸ¥
        exec "$OLD_CLI_SCRIPT" "$@"
    else
        # ä½¿ç”¨ ANSI çº¢è‰²è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ° stderr
        echo -e "\033[0;1;31;91mé”™è¯¯: æ—§ç‰ˆ CLI è„šæœ¬ '$OLD_CLI_SCRIPT' æœªæ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œã€‚\033[0m" >&2
        exit 1
    fi
    # å¦‚æœ exec æˆåŠŸï¼Œå½“å‰è„šæœ¬çš„æ‰§è¡Œä¼šåœ¨æ­¤å¤„ç»ˆæ­¢
fi


#  Dialog é¢œè‰²å®šä¹‰ 
RESET='\Zn'
BOLD='\Zb'
FG_BLACK='\Z0'
FG_RED='\Z1'
FG_GREEN='\Z2'
FG_YELLOW='\Z3'
FG_BLUE='\Z4'
FG_MAGENTA='\Z5'
FG_CYAN='\Z6'
FG_WHITE='\Z7'

#  ANSI é¢œè‰²å®šä¹‰ (ç”¨äº echo -e) 
ANSI_RESET='\e[0m'
ANSI_BOLD='\e[1m'
ANSI_RED='\e[31m'
ANSI_GREEN='\e[32m'
ANSI_YELLOW='\e[33m'
ANSI_BLUE='\e[34m'
ANSI_MAGENTA='\e[35m'
ANSI_CYAN='\e[36m'
ANSI_WHITE='\e[37m'

#  Root permission check at the beginning 
# The script now runs as a normal user by default.

#  ä¾èµ–æ£€æŸ¥ (dialog å¿…é¡»å…ˆæ£€æŸ¥ï¼Œå› ä¸ºåç»­æç¤ºä¾èµ–å®ƒ) 
if ! command -v dialog &> /dev/null; then
    echo -e "${ANSI_RED}é”™è¯¯: æ ¸å¿ƒä¾èµ– 'dialog' æœªæ‰¾åˆ°ï¼${ANSI_RESET}" >&2
    echo "è¯·å…ˆæ‰‹åŠ¨å®‰è£… dialog (ä¾‹å¦‚: sudo apt install dialog) å†è¿è¡Œæ­¤è„šæœ¬ã€‚" >&2
    exit 1
fi

mkdir -p "$RUN_DIR" "$LOG_DIR"
# æ”¯æŒçš„ç³»ç»Ÿæœ‰ubuntu20+/debian10+ã€centos7+

#  Napcat å®‰è£…æ£€æŸ¥ 
if [[ ! -d "$NAPCAT_DIR" ]]; then
    dialog --colors --title "Napcat æœªå®‰è£…" --yesno "åœ¨ç”¨æˆ· '${TARGET_USER}' çš„ç›®å½•ä¸‹æœªæ£€æµ‹åˆ° Napcat ('$NAPCAT_DIR' ä¸å­˜åœ¨)ã€‚\n\næ˜¯å¦ç°åœ¨ä¸‹è½½å¹¶æ‰§è¡Œå®˜æ–¹å®‰è£…è„šæœ¬ï¼Ÿ" 10 70 2>&1 >/dev/tty
    choice=$?
    clear
    if [[ $choice -eq 0 ]]; then # Yes
        dialog --colors --title "æ­£åœ¨å®‰è£… Napcat" --infobox "æ­£åœ¨ä» $INSTALL_SCRIPT_URL ä¸‹è½½å®‰è£…è„šæœ¬..." 5 70
        if curl -Lo "$INSTALL_SCRIPT_LOCAL" "$INSTALL_SCRIPT_URL"; then
            dialog --colors --title "æ­£åœ¨å®‰è£… Napcat" --infobox "ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨æ‰§è¡Œå®‰è£…è„šæœ¬ (bash $INSTALL_SCRIPT_LOCAL)..." 5 70
            # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶æ‰§è¡Œ
            chmod +x "$INSTALL_SCRIPT_LOCAL"
            if bash "$INSTALL_SCRIPT_LOCAL"; then
                dialog --colors --title "å®‰è£…æˆåŠŸ" --msgbox "Napcat å®‰è£…è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼\nè¯·é‡æ–°è¿è¡Œ NapcatShell ä»¥ç»§ç»­ã€‚" 8 60
                rm -f "$INSTALL_SCRIPT_LOCAL" # æ¸…ç†å®‰è£…è„šæœ¬
                exit 0
            else
                dialog --colors --title "å®‰è£…å¤±è´¥" --msgbox "${FG_RED}Napcat å®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥ã€‚${RESET}\nè¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯æˆ–å°è¯•æ‰‹åŠ¨å®‰è£…ã€‚" 8 60
                rm -f "$INSTALL_SCRIPT_LOCAL" # æ¸…ç†å®‰è£…è„šæœ¬
                exit 1
            fi
        else
            dialog --colors --title "ä¸‹è½½å¤±è´¥" --msgbox "${FG_RED}æ— æ³•ä¸‹è½½å®‰è£…è„šæœ¬: $INSTALL_SCRIPT_URL${RESET}\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– URL æ˜¯å¦æœ‰æ•ˆã€‚" 8 70
            exit 1
        fi
    else # No or Cancel
        dialog --colors --title "å·²å–æ¶ˆ" --msgbox "å·²è·³è¿‡ Napcat å®‰è£…ã€‚è„šæœ¬æ— æ³•ç»§ç»­ã€‚" 6 50
        exit 0
    fi
fi

#  é¦–æ¬¡è¿è¡Œä¾èµ–æ£€æŸ¥ä¸å®‰è£… 
if [[ ! -f "$INIT_FLAG" ]]; then
    dialog --colors --title "é¦–æ¬¡è¿è¡Œè®¾ç½®" --infobox "æ­£åœ¨è¿›è¡Œé¦–æ¬¡è¿è¡Œè®¾ç½®ï¼Œæ£€æŸ¥æ‰€éœ€ä¾èµ–..." 5 60
    sleep 1

    dependencies=("sudo" "dialog" "jq" "pgrep" "ffmpeg" "curl" "ps" "kill" "grep" "sed" "tee" "mktemp" "flock" "ss") # æ·»åŠ æ›´å¤šåŸºç¡€å‘½ä»¤
    missing_deps=()
    install_needed=false

    # é¦–æ¬¡æ£€æŸ¥
    for cmd in "${dependencies[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            missing_deps+=("$cmd")
            install_needed=true
        fi
    done

    if $install_needed; then
        dialog --colors --title "ä¾èµ–ç¼ºå¤±" --infobox "æ£€æµ‹åˆ°ä»¥ä¸‹ä¾èµ–ç¼ºå¤±ï¼Œå°†å°è¯•è‡ªåŠ¨å®‰è£…ï¼š\n${missing_deps[*]}" 8 60
        sleep 2

        package_manager=""
        install_cmd=""
        update_cmd=""
        install_opts="-y" # é»˜è®¤ä½¿ç”¨ -y

        if command -v apt-get &> /dev/null; then
            package_manager="apt-get"
            update_cmd="sudo apt-get update"
            # Debian/Ubuntu åŒ…åæ˜ å°„ (å¯èƒ½ä¸å®Œæ•´)
            declare -A pkg_map=( ["pgrep"]="procps" ["ffmpeg"]="ffmpeg" ["jq"]="jq" ["dialog"]="dialog" ["curl"]="curl" ["ps"]="procps" ["kill"]="procps" ["grep"]="grep" ["sed"]="sed" ["tee"]="coreutils" ["mktemp"]="coreutils" ["flock"]="util-linux" ["ss"]="iproute2" ["sudo"]="sudo" )
            install_packages=()
            for dep in "${missing_deps[@]}"; do
                pkg=${pkg_map[$dep]}
                [[ -n "$pkg" ]] && install_packages+=("$pkg")
            done
            # å»é‡
            install_packages=($(echo "${install_packages[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
            [[ ${#install_packages[@]} -gt 0 ]] && install_cmd="sudo $package_manager install $install_opts ${install_packages[*]}"

        elif command -v yum &> /dev/null; then
            package_manager="yum"
            update_cmd="" # yum é€šå¸¸ä¸éœ€è¦æ˜¾å¼ update
            # CentOS/RHEL åŒ…åæ˜ å°„
            declare -A pkg_map=( ["pgrep"]="procps-ng" ["ffmpeg"]="ffmpeg" ["jq"]="jq" ["dialog"]="dialog" ["curl"]="curl" ["ps"]="procps-ng" ["kill"]="procps-ng" ["grep"]="grep" ["sed"]="sed" ["tee"]="coreutils" ["mktemp"]="coreutils" ["flock"]="util-linux" ["ss"]="iproute" ["sudo"]="sudo" )
            # CentOS å¯èƒ½éœ€è¦ epel-release æ¥å®‰è£… jq å’Œ ffmpeg
            needs_epel=false
            for dep in "${missing_deps[@]}"; do
                if [[ "$dep" == "jq" || "$dep" == "ffmpeg" ]]; then
                    needs_epel=true
                    break
                fi
            done
            if $needs_epel && ! rpm -q epel-release &>/dev/null; then
                 update_cmd="sudo yum install $install_opts epel-release" # å…ˆè£… epel
            fi
            install_packages=()
            for dep in "${missing_deps[@]}"; do
                pkg=${pkg_map[$dep]}
                [[ -n "$pkg" ]] && install_packages+=("$pkg")
            done
            install_packages=($(echo "${install_packages[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
            [[ ${#install_packages[@]} -gt 0 ]] && install_cmd="sudo $package_manager install $install_opts ${install_packages[*]}"

        elif command -v dnf &> /dev/null; then
            package_manager="dnf"
            update_cmd="" # dnf é€šå¸¸ä¸éœ€è¦
            # Fedora åŒ…åæ˜ å°„
             declare -A pkg_map=( ["pgrep"]="procps-ng" ["ffmpeg"]="ffmpeg" ["jq"]="jq" ["dialog"]="dialog" ["curl"]="curl" ["ps"]="procps-ng" ["kill"]="procps-ng" ["grep"]="grep" ["sed"]="sed" ["tee"]="coreutils" ["mktemp"]="coreutils" ["flock"]="util-linux" ["ss"]="iproute" ["sudo"]="sudo" )
            install_packages=()
            for dep in "${missing_deps[@]}"; do
                pkg=${pkg_map[$dep]}
                [[ -n "$pkg" ]] && install_packages+=("$pkg")
            done
            install_packages=($(echo "${install_packages[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
            [[ ${#install_packages[@]} -gt 0 ]] && install_cmd="sudo $package_manager install $install_opts ${install_packages[*]}"
        else
            dialog --colors --title "é”™è¯¯" --msgbox "${FG_RED}æ— æ³•è¯†åˆ«çš„åŒ…ç®¡ç†å™¨ã€‚è¯·æ‰‹åŠ¨å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š${RESET}\n${missing_deps[*]}" 10 60
            exit 1
        fi

        # æ‰§è¡Œå®‰è£…
        if [[ -n "$install_cmd" ]]; then
            dialog --colors --title "æ­£åœ¨å®‰è£…ä¾èµ–" --infobox "æ‰§è¡Œæ›´æ–°å‘½ä»¤: $update_cmd\næ‰§è¡Œå®‰è£…å‘½ä»¤: $install_cmd" 10 70
            eval "$update_cmd" # æ‰§è¡Œæ›´æ–°å‘½ä»¤
            if eval "$install_cmd"; then
                dialog --colors --title "å®‰è£…æˆåŠŸ" --infobox "ä¾èµ–å®‰è£…å°è¯•å®Œæˆã€‚" 5 60
                sleep 1
            else
                dialog --colors --title "å®‰è£…å¤±è´¥" --msgbox "${FG_RED}ä¾èµ–å®‰è£…å¤±è´¥ã€‚${RESET}\nè¯·å°è¯•æ‰‹åŠ¨å®‰è£…ç¼ºå¤±çš„ä¾èµ–ã€‚" 8 60
                # ä¸é€€å‡ºï¼Œç»§ç»­æ£€æŸ¥ï¼Œè®©ç”¨æˆ·çŸ¥é“å“ªäº›è¿˜æ²¡è£…ä¸Š
            fi
        else
             dialog --colors --title "è­¦å‘Š" --msgbox "${FG_YELLOW}æœªèƒ½ç¡®å®šéœ€è¦å®‰è£…çš„åŒ…ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ä¾èµ–ã€‚${RESET}" 8 60
        fi

        # å†æ¬¡æ£€æŸ¥ä¾èµ–
        missing_deps=()
        for cmd in "${dependencies[@]}"; do
            if ! command -v "$cmd" &> /dev/null; then
                missing_deps+=("$cmd")
            fi
        done

        if [[ ${#missing_deps[@]} -gt 0 ]]; then
            dialog --colors --title "ä¾èµ–æ£€æŸ¥å¤±è´¥" --msgbox "${FG_RED}ä»¥ä¸‹ä¾èµ–åœ¨å°è¯•å®‰è£…åä»ç„¶ç¼ºå¤±ï¼š${RESET}\n${missing_deps[*]}\n\n${FG_RED}è„šæœ¬æ— æ³•ç»§ç»­ï¼Œè¯·æ‰‹åŠ¨å®‰è£…å®ƒä»¬ã€‚${RESET}" 12 60
            exit 1
        fi

    fi # end if $install_needed

    # æ‰€æœ‰ä¾èµ–æ£€æŸ¥é€šè¿‡ï¼Œåˆ›å»ºæ ‡è®°æ–‡ä»¶
    dialog --colors --title "è®¾ç½®å®Œæˆ" --infobox "ä¾èµ–æ£€æŸ¥é€šè¿‡ï¼Œåˆ›å»ºé¦–æ¬¡è¿è¡Œæ ‡è®°..." 5 60
    if echo "1" > "$INIT_FLAG"; then
        sleep 1
    else
        dialog --colors --title "è­¦å‘Š" --msgbox "${FG_YELLOW}æ— æ³•åˆ›å»ºé¦–æ¬¡è¿è¡Œæ ‡è®°æ–‡ä»¶ '$INIT_FLAG'ã€‚${RESET}\nä¾èµ–æ£€æŸ¥å¯èƒ½ä¼šåœ¨ä¸‹æ¬¡è¿è¡Œæ—¶é‡å¤æ‰§è¡Œã€‚" 8 70
        sleep 2
    fi
    clear
fi # end if init flag check

check_for_update() {
    local urls=(
        "https://nclatest.znin.net/"
        "https://jiashu.1win.eu.org/https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest"
		"https://napcatversion.109834.xyz/https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest"
        "https://spring-night-57a1.3540746063.workers.dev/https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest"
		"https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest"
    )
    local result_file
    result_file=$(mktemp) # Make temp file local to function scope
    # Setup trap local to the function's execution context
    trap 'rm -f "$result_file"; pkill -P $$ &>/dev/null' RETURN INT TERM

    local latest_tag_numeric=""
    local original_tag=""
    local numeric_tag=""

    #  å­å‡½æ•°ï¼šè·å–æ ‡ç­¾å¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ (ä¿æŒä¸å˜) 
    fetch_and_write() {
        local url="$1"
        local tmp_file="$2"
        local tag
        # å°† jq çš„ stderr é‡å®šå‘åˆ° /dev/null
        tag=$(curl -s --connect-timeout 5 "$url" | jq -r '.tag_name // empty' 2>/dev/null)
        # æ£€æŸ¥ jq çš„é€€å‡ºçŠ¶æ€ä»¥åŠ tag æ˜¯å¦æœ‰æ•ˆ
        if [[ $? -eq 0 ]] && [[ -n "$tag" ]] && [[ "$tag" != "null" ]]; then
            (
                # ä½¿ç”¨ flock ç¡®ä¿åªæœ‰ä¸€ä¸ªè¿›ç¨‹å†™å…¥æ–‡ä»¶
                flock -n 9 || exit 1
                # å†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©ºï¼Œé˜²æ­¢å¹¶å‘å†™å…¥è¦†ç›–
                if [[ ! -s "$tmp_file" ]]; then
                    echo "$tag" > "$tmp_file"
                fi
            ) 9>"$tmp_file"
        # else # å¯é€‰ï¼šå¦‚æœéœ€è¦è®°å½• jq å¤±è´¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ—¥å¿—
            # echo "jq failed or returned empty/null for $url" >&2
        fi
    }
    #  å­å‡½æ•°ç»“æŸ 

    #  å¹¶å‘è·å–è¿œç¨‹ç‰ˆæœ¬ 
    local url
    for url in "${urls[@]}"; do
        fetch_and_write "$url" "$result_file" &
    done

    local wait_timeout=5
    local i
    for (( i=0; i < wait_timeout * 10; i++ )); do
        if [[ -s "$result_file" ]]; then
            break
        fi
        sleep 0.1
    done
    #  è·å–ç»“æŸ 

    #  å¤„ç†è¿œç¨‹ç‰ˆæœ¬ç»“æœ 
    if [[ -s "$result_file" ]]; then
        original_tag=$(head -n 1 "$result_file")
        # å»é™¤ v å’Œ . åªç•™ä¸‹æ•°å­—
        numeric_tag="${original_tag//[v.]/}"
        echo "è·å–åˆ°æœ€æ–°å‘å¸ƒç‰ˆæœ¬çš„æ•°å­—æ ‡ç­¾æ˜¯: $numeric_tag"
        latest_tag_numeric=$numeric_tag
    else
        echo "é”™è¯¯ï¼šåœ¨ ${wait_timeout} ç§’å†…æœªèƒ½ä»ä»»ä½•æºè·å–è¿œç¨‹ç‰ˆæœ¬æ ‡ç­¾ã€‚" >&2
        return 2 # API æŸ¥è¯¢å¤±è´¥
    fi
    #  å¤„ç†ç»“æŸ 

    #  è·å–å¹¶å¤„ç†æœ¬åœ°ç‰ˆæœ¬ 
    #   Use dynamic path 
    local local_file="$INSTALL_BASE_DIR/opt/QQ/resources/app/app_launcher/napcat/napcat.mjs"
    local local_version_string=""
    local local_version_numeric=""

    if [[ ! -f "$local_file" ]] || [[ ! -r "$local_file" ]]; then
        echo "é”™è¯¯ï¼šæ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ '$local_file'ã€‚" >&2
        return 2 # æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œè§†ä¸ºå¤±è´¥
    fi

    # å°è¯•æå–ç‰ˆæœ¬å­—ç¬¦ä¸²
    # ä½¿ç”¨ grep æŸ¥æ‰¾åŒ…å« 'const version = "' çš„è¡Œï¼Œç„¶åç”¨ sed æå–å¼•å·å†…çš„å†…å®¹
    local_version_string=$(grep 'const version = "' "$local_file" | sed -n 's/.*const version = "\([^"]*\)".*/\1/p')

    if [[ -z "$local_version_string" ]]; then
        echo "é”™è¯¯ï¼šæ— æ³•åœ¨ '$local_file' ä¸­æ‰¾åˆ° 'const version = \"...\"' æ ¼å¼çš„ç‰ˆæœ¬å·ã€‚" >&2
        return 2 # æ— æ³•è§£ææœ¬åœ°ç‰ˆæœ¬ï¼Œè§†ä¸ºå¤±è´¥
    fi

    # å»é™¤ v å’Œ . åªç•™ä¸‹æ•°å­—
    local_version_numeric="${local_version_string//[v.]/}"
    echo "è·å–åˆ°æœ¬åœ°ç‰ˆæœ¬çš„æ•°å­—æ ‡ç­¾æ˜¯: $local_version_numeric"
    #  æœ¬åœ°ç‰ˆæœ¬å¤„ç†ç»“æŸ 

    #  ç‰ˆæœ¬æ¯”è¾ƒ 
    # ç¡®ä¿ä¸¤è€…éƒ½æ˜¯æ•°å­—ï¼ˆæˆ–è‡³å°‘çœ‹èµ·æ¥åƒæ•°å­—ï¼‰
    if ! [[ "$latest_tag_numeric" =~ ^[0-9]+$ ]] || ! [[ "$local_version_numeric" =~ ^[0-9]+$ ]]; then
         echo "é”™è¯¯ï¼šè·å–åˆ°çš„ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•æ¯”è¾ƒã€‚" >&2
         return 2 # ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯
    fi

    # ä½¿ç”¨ Bash ç®—æœ¯æ¯”è¾ƒ
    if [[ "$latest_tag_numeric" -gt "$local_version_numeric" ]]; then
        echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ (è¿œç¨‹: $original_tag > æœ¬åœ°: $local_version_string)ã€‚"
        return 1 # API ç‰ˆæœ¬å¤§äºæœ¬åœ°ç‰ˆæœ¬
    else
        echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ–æ›´æ–° (è¿œç¨‹: $original_tag <= æœ¬åœ°: $local_version_string)ã€‚"
        return 0 # API ç‰ˆæœ¬å°äºæˆ–ç­‰äºæœ¬åœ°ç‰ˆæœ¬
    fi
    #  æ¯”è¾ƒç»“æŸ 
}


# è¾…åŠ©å‡½æ•°ï¼šé€’å½’è·å–æ‰€æœ‰åä»£ PID
_get_all_descendant_pids() {
    local ppid="$1"
    local children
    children=$(pgrep -P "$ppid" 2>/dev/null)
    for child in $children; do
        echo "$child"
        _get_all_descendant_pids "$child"
    done
}

_get_napcat_pid_and_account() {
    local candidate_pids
    local final_pids=()
    local qq_account=""
    local pid_file="$RUN_DIR/napcat.pid"

    # æ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„å€™é€‰è¿›ç¨‹
    readarray -t candidate_pids < <(pgrep  -f ".*/qq --no-sandbox -q [0-9]{4,}")

    # å¦‚æœä¸€ä¸ªå€™é€‰è€…éƒ½æ²¡æœ‰ï¼Œç›´æ¥è¿”å›
    if [[ ${#candidate_pids[@]} -eq 0 ]]; then
        [[ -f "$pid_file" ]] && rm -f "$pid_file"
        return 1 # æœªè¿è¡Œ
    fi

    # åªä¿ç•™é¡¶å±‚çˆ¶è¿›ç¨‹
    for pid in "${candidate_pids[@]}"; do
        local ppid
        ppid=$(ps -o ppid= -p "$pid" | tr -d ' ') # è·å–çˆ¶è¿›ç¨‹IDå¹¶å»é™¤ç©ºæ ¼
        
        local is_child=false
        # æ£€æŸ¥è¿™ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹(ppid)æ˜¯å¦ä¹Ÿæ˜¯ä¸€ä¸ªå€™é€‰è€…
        for other_pid in "${candidate_pids[@]}"; do
            if [[ "$ppid" == "$other_pid" ]]; then
                is_child=true
                break
            fi
        done

        # å¦‚æœå®ƒä¸æ˜¯ä»»ä½•å…¶ä»–å€™é€‰è€…çš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªé¡¶å±‚çˆ¶è¿›ç¨‹
        if ! $is_child; then
            final_pids+=("$pid")
        fi
    done


    # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¤šä¸ªç‹¬ç«‹çš„é¡¶å±‚å®ä¾‹
    if [[ ${#final_pids[@]} -gt 1 ]]; then
        echo -e "${ANSI_YELLOW}è­¦å‘Š: æ£€æµ‹åˆ° ${#final_pids[@]} ä¸ªç‹¬ç«‹çš„ Napcat å®ä¾‹ã€‚å°†è‡ªåŠ¨æ¸…ç†å¤šä½™è¿›ç¨‹ï¼Œåªä¿ç•™ä¸€ä¸ª...${ANSI_RESET}" >&2
        
        # ä¿ç•™ç¬¬ä¸€ä¸ªPIDï¼Œå¹¶ç»ˆæ­¢å…¶ä½™çš„
        local pids_to_kill=("${final_pids[@]:1}")
        for pid_to_kill in "${pids_to_kill[@]}"; do
            echo "æ­£åœ¨ç»ˆæ­¢å¤šä½™çš„çˆ¶è¿›ç¨‹ PID: $pid_to_kill..." >&2
            # ä½¿ç”¨é€’å½’å‡½æ•°æ‰¾åˆ°æ‰€æœ‰åä»£è¿›ç¨‹å¹¶ä¸€å¹¶æ€æ­»
            local all_pids_to_kill=("$pid_to_kill" $(_get_all_descendant_pids "$pid_to_kill"))
            kill "${all_pids_to_kill[@]}" 2>/dev/null && sleep 0.5
            if kill -0 "$pid_to_kill" 2>/dev/null; then
                kill -9 "${all_pids_to_kill[@]}" 2>/dev/null
            fi
        done
        # æ›´æ–° final_pids æ•°ç»„ï¼Œåªä¿ç•™æˆ‘ä»¬å†³å®šç•™ä¸‹çš„é‚£ä¸€ä¸ª
        final_pids=("${final_pids[0]}")
    fi

    # æ­¤æ—¶ï¼Œfinal_pids æ•°ç»„ä¸­åº”è¯¥åªæœ‰ 0 æˆ– 1 ä¸ªå…ƒç´ 
    if [[ ${#final_pids[@]} -eq 0 ]]; then
        [[ -f "$pid_file" ]] && rm -f "$pid_file"
        return 1 # æœªè¿è¡Œ (å¯èƒ½æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯å­è¿›ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§å¼‚å¸¸æƒ…å†µï¼Œä½†ä¹Ÿè§†ä¸ºæœªè¿è¡Œ)
    fi

    # ç¡®è®¤æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹
    local pid="${final_pids[0]}"
    local cmdline
    cmdline=$(ps -o cmd= -p "$pid" 2>/dev/null)

    # ä»å‘½ä»¤è¡Œä¸­æå– QQ è´¦å·
    if [[ "$cmdline" =~ --no-sandbox[[:space:]]+-q[[:space:]]+([0-9]{4,}) ]]; then
        qq_account="${BASH_REMATCH[1]}"
        echo "$pid" > "$pid_file"
        echo "$qq_account" # å‘ stdout è¾“å‡º QQ è´¦å·
        return 0 # è¿è¡Œä¸­
    else
        echo "$pid" # è¾“å‡º PID ä»¥ä¾›è°ƒè¯•
        return 2 # çŠ¶æ€æœªçŸ¥
    fi
}

# å¤åˆ¶ get_napcat_status å‡½æ•° (æˆ–è€…ç†æƒ³æƒ…å†µä¸‹ä»å…±äº«åº“åŠ è½½)
get_napcat_status() {
    local status_code
    local output

    # è°ƒç”¨å†…éƒ¨å‡½æ•°ï¼Œæ•è·è¾“å‡ºå’ŒçŠ¶æ€ç 
    output=$(_get_napcat_pid_and_account)
    status_code=$?

    case $status_code in
        0) # è¿è¡Œä¸­
            local qq_account="$output"
            echo -e "${FG_GREEN}è¿è¡Œä¸­ğŸ˜‹ - ${BOLD}$qq_account${RESET}"
            ;;
        1 | 3) # æœªè¿è¡Œ æˆ– PID æ–‡ä»¶é—®é¢˜
            echo -e "${FG_YELLOW}æœªè¿è¡ŒğŸ˜´${RESET}"
            ;;
        2) # çŠ¶æ€æœªçŸ¥
            local pid="$output"
            echo -e "${FG_RED}çŠ¶æ€æœªçŸ¥ğŸ¤” (PID: ${BOLD}$pid${RESET})${RESET}"
            ;;
        *) # å…¶ä»–æœªçŸ¥é”™è¯¯
             echo -e "${FG_RED}æ£€æŸ¥çŠ¶æ€å‡ºé”™${RESET}"
             ;;
    esac
    # æ­¤å‡½æ•°ç°åœ¨åªè´Ÿè´£ echoï¼Œä¸è¿”å›çŠ¶æ€ç ç»™è°ƒç”¨è€…
}


stop_napcat() {
    dialog --colors --title "åœæ­¢ Napcat" --infobox "æ­£åœ¨å°è¯•åœæ­¢ Napcat..." 5 50
    
    # --- ä½¿ç”¨ä¸ä¸Šé¢å®Œå…¨ç›¸åŒçš„é€»è¾‘æ¥æ‰¾åˆ°æ‰€æœ‰é¡¶å±‚çˆ¶è¿›ç¨‹ ---
    local candidate_pids
    local final_pids=()
    readarray -t candidate_pids < <(pgrep  -f ".*/qq --no-sandbox -q [0-9]{4,}")

    if [[ ${#candidate_pids[@]} -gt 0 ]]; then
        for pid in "${candidate_pids[@]}"; do
            local ppid
            ppid=$(ps -o ppid= -p "$pid" | tr -d ' ')
            local is_child=false
            for other_pid in "${candidate_pids[@]}"; do
                if [[ "$ppid" == "$other_pid" ]]; then
                    is_child=true
                    break
                fi
            done
            if ! $is_child; then
                final_pids+=("$pid")
            fi
        done
    fi


    if [[ ${#final_pids[@]} -eq 0 ]]; then
        dialog --colors --title "æ— éœ€åœæ­¢" --msgbox "Napcat æœªåœ¨è¿è¡Œã€‚" 6 50
        [[ -f "$RUN_DIR/napcat.pid" ]] && rm -f "$RUN_DIR/napcat.pid"
        return
    fi

    echo -e "${ANSI_YELLOW}æ­£åœ¨ç»ˆæ­¢ Napcat å®ä¾‹ (çˆ¶è¿›ç¨‹: ${final_pids[*]})...${ANSI_RESET}"
    local all_stopped=true
    for pid in "${final_pids[@]}"; do
        # æ‰¾åˆ°æ‰€æœ‰åä»£è¿›ç¨‹ï¼Œç¡®ä¿æ•´ä¸ªè¿›ç¨‹æ ‘è¢«æ¸…ç†
        local all_pids_to_kill=("$pid" $(_get_all_descendant_pids "$pid"))
        echo "æ­£åœ¨ç»ˆæ­¢è¿›ç¨‹æ ‘ (PID: $pid)..."
        kill "${all_pids_to_kill[@]}" 2>/dev/null
    done
    
    sleep 2 # ç­‰å¾…è¿›ç¨‹æ­£å¸¸é€€å‡º

    for pid in "${final_pids[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            local all_pids_to_kill=("$pid" $(_get_all_descendant_pids "$pid"))
            echo -e "${ANSI_RED}æ­£å¸¸ç»ˆæ­¢å¤±è´¥ (PID: $pid)ï¼Œå°è¯•å¼ºåˆ¶ç»ˆæ­¢...${ANSI_RESET}"
            kill -9 "${all_pids_to_kill[@]}" 2>/dev/null
            sleep 1
        fi
        if kill -0 "$pid" 2>/dev/null; then
            all_stopped=false
        fi
    done

    if $all_stopped; then
        echo -e "${ANSI_GREEN}æ‰€æœ‰ç›¸å…³è¿›ç¨‹å·²ç»ˆæ­¢ã€‚${ANSI_RESET}"
        rm -f "$RUN_DIR/napcat.pid"
        dialog --colors --title "åœæ­¢æˆåŠŸ" --msgbox "Napcat è¿›ç¨‹å·²åœæ­¢ã€‚" 6 50
    else
        dialog --colors --title "åœæ­¢å¤±è´¥" --msgbox "${FG_RED}æ— æ³•åœæ­¢æ‰€æœ‰ Napcat è¿›ç¨‹ã€‚${RESET}\nè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚" 8 60
    fi
}

update_napcat() {
    dialog --colors --title "æ›´æ–° Napcat" --yesno "è¿™å°†ä»¥å½“å‰ç”¨æˆ· (${TARGET_USER}) æƒé™æ‰§è¡Œå®˜æ–¹åœ¨çº¿å®‰è£…/æ›´æ–°è„šæœ¬ã€‚\n\nå‚æ•°: --docker n --cli y\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ" 10 70 2>&1 >/dev/tty
    choice=$?
    clear
    if [[ $choice -eq 0 ]]; then # Yes
        dialog --colors --title "æ­£åœ¨æ›´æ–° Napcat" --infobox "æ­£åœ¨æ‰§è¡Œåœ¨çº¿æ›´æ–°è„šæœ¬...\ncurl -sSL $INSTALL_SCRIPT_URL | bash -s -- --docker n --cli y" 8 70
        # ç›´æ¥ä»¥å½“å‰ç”¨æˆ·æƒé™æ‰§è¡Œåœ¨çº¿è„šæœ¬
        if curl -sSL "$INSTALL_SCRIPT_URL" | bash -s -- --docker n --cli y; then
            dialog --colors --title "æ›´æ–°æˆåŠŸ" --msgbox "Napcat æ›´æ–°è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼" 6 50
        else
            dialog --colors --title "æ›´æ–°å¤±è´¥" --msgbox "${FG_RED}Napcat æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥ã€‚${RESET}\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è„šæœ¬è¾“å‡ºã€‚" 8 60
        fi
    else
        dialog --colors --title "å·²å–æ¶ˆ" --msgbox "æ›´æ–°æ“ä½œå·²å–æ¶ˆã€‚" 6 40
    fi
}

view_log() {
    local status_code
    local output
    local current_qq_account=""
    local current_qq_log_file_path="" # å½“å‰æ´»åŠ¨QQçš„æ—¥å¿—æ–‡ä»¶å®Œæ•´è·¯å¾„
    local log_menu_items=()           # Dialogèœå•é¡¹æ•°ç»„
    local log_file_path               # å¾ªç¯æ—¶ä½¿ç”¨çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„
    local qq_from_filename            # ä»æ–‡ä»¶åæå–çš„QQå·
    local bn                          # basename
    local choice_tag                  # Dialogé€‰æ‹©çš„æ ‡ç­¾ï¼ˆå³æ–‡ä»¶è·¯å¾„ï¼‰
    local dialog_exit_status          # Dialogé€€å‡ºçŠ¶æ€

    # è·å–å½“å‰è¿è¡Œçš„QQå·
    output=$(_get_napcat_pid_and_account)
    status_code=$?

    if [[ "$status_code" -eq 0 ]]; then
        current_qq_account="$output"
        current_qq_log_file_path="$LOG_DIR/napcat_${current_qq_account}.log"
    fi

    # æŸ¥æ‰¾æ‰€æœ‰çš„napcatæ—¥å¿—æ–‡ä»¶
    local all_log_files=()
    while IFS= read -r -d $'\0' file; do
        all_log_files+=("$file")
    done < <(find "$LOG_DIR/" -maxdepth 1 -type f -name "napcat_*.log" -print0)

    if [[ ${#all_log_files[@]} -eq 0 ]]; then
        dialog --colors --title "æ—¥å¿—æ–‡ä»¶ç¼ºå¤±" --msgbox "åœ¨ $LOG_DIR/ ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ° Napcat æ—¥å¿—æ–‡ä»¶ã€‚" 8 60
        return 1
    fi

    # å¡«å……èœå•é¡¹
    local active_log_added_to_menu=false
    # ä¼˜å…ˆæ·»åŠ å½“å‰è¿è¡Œçš„QQ
    if [[ -n "$current_qq_account" ]] && [[ -f "$current_qq_log_file_path" ]]; then
        
        local found_active_in_all=false
        for file_in_all in "${all_log_files[@]}"; do
            if [[ "$file_in_all" == "$current_qq_log_file_path" ]]; then
                found_active_in_all=true
                break
            fi
        done
        if $found_active_in_all; then
            log_menu_items+=("$current_qq_log_file_path" "QQ: $current_qq_account ${FG_GREEN}(å½“å‰æ´»åŠ¨)${RESET}")
            active_log_added_to_menu=true
        fi
    fi

    # æ·»åŠ å…¶ä»–æ—¥å¿—æ–‡ä»¶
    for log_file_path in "${all_log_files[@]}"; do
        # å¦‚æœæ˜¯æ´»åŠ¨æ—¥å¿—ä¸”å·²è¢«æ·»åŠ 
        if $active_log_added_to_menu && [[ "$log_file_path" == "$current_qq_log_file_path" ]]; then
            continue
        fi

        bn=$(basename "$log_file_path")
        if [[ "$bn" =~ napcat_([0-9]+)\.log ]]; then
            qq_from_filename="${BASH_REMATCH[1]}"
            log_menu_items+=("$log_file_path" "QQ: $qq_from_filename")
        else
            # å¯¹äºä¸ç¬¦åˆ napcat_NUM.log æ ¼å¼çš„æ–‡ä»¶å
            log_menu_items+=("$log_file_path" "$bn")
        fi
    done

    if [[ ${#log_menu_items[@]} -eq 0 ]]; then
        # æ­¤æƒ…å†µæ„å‘³ç€æ‰¾åˆ°äº†æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ— æ³•å¤„ç†æˆèœå•é¡¹
        dialog --colors --title "æ— æœ‰æ•ˆæ—¥å¿—" --msgbox "æ‰¾åˆ°äº†æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ— æ³•è§£æä»¥ä¾›é€‰æ‹©ã€‚" 8 70
        return 1
    fi

    local num_dialog_items=$(( ${#log_menu_items[@]} / 2 ))
    # å¦‚æœèœå•é¡¹æ•°é‡ä¸º0
    if [[ $num_dialog_items -eq 0 ]]; then
        dialog --colors --title "é”™è¯¯" --msgbox "å‡†å¤‡æ—¥å¿—èœå•æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ã€‚" 8 60
        return 1
    fi
    
    choice_tag=$(dialog --colors --title "é€‰æ‹©æ—¥å¿—æ–‡ä»¶" \
                        --ok-label "æŸ¥çœ‹" \
                        --cancel-label "è¿”å›" \
                        --menu "è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥å¿—æ–‡ä»¶:" \
                        20 70 "$num_dialog_items" \
                        "${log_menu_items[@]}" \
                        2>&1 >/dev/tty)
    
    dialog_exit_status=$?
    clear # æ¸…é™¤Dialogç•Œé¢

    if [[ $dialog_exit_status -eq 0 ]]; then # "æŸ¥çœ‹"
        local selected_log_file="$choice_tag" 
        if [[ -n "$selected_log_file" ]] && [[ -f "$selected_log_file" ]] && [[ -r "$selected_log_file" ]]; then
            echo -e "${ANSI_GREEN}æ­£åœ¨æ‰“å¼€æ—¥å¿—: ${ANSI_BOLD}$selected_log_file${ANSI_RESET}"
            echo -e "${ANSI_YELLOW}ä½¿ç”¨ â†‘ â†“ç®­å¤´é”® æˆ– PageUp/PageDown é”®ç¿»é¡µ, æŒ‰ 'q' é”®é€€å‡ºæŸ¥çœ‹ã€‚${ANSI_RESET}"
            sleep 1
            less -R +G "$selected_log_file" 
            clear # lessé€€å‡ºåæ¸…ç†å±å¹•
            return 0
        else
            dialog --colors --title "æ–‡ä»¶é”™è¯¯" --msgbox "${FG_RED}é€‰æ‹©çš„æ—¥å¿—æ–‡ä»¶æ— æ³•è®¿é—®æˆ–æ— æ•ˆ:${RESET}\n$selected_log_file" 8 70
            return 1
        fi
    else # ç”¨æˆ·æŒ‰ä¸‹äº† "è¿”å›" æˆ– ESC
        # ä¸éœ€è¦é¢å¤–æç¤ºï¼Œç›´æ¥è¿”å›ä¸»èœå•
        return 1 
    fi
}
#  ä¸»èœå•å¾ªç¯ 
while true; do
    # æ£€æŸ¥æ›´æ–°
    check_for_update
    update_check_status=$?
    update_display_status=""
    case $update_check_status in
        1) update_display_status="${FG_YELLOW}æœ‰å¯ç”¨æ›´æ–°${RESET}" ;;
        0) update_display_status="${FG_GREEN}å·²æ˜¯æœ€æ–°${RESET}" ;;
        *) update_display_status="${FG_RED}æ£€æŸ¥å¤±è´¥${RESET}" ;;
    esac

    # è·å–è¿è¡ŒçŠ¶æ€
    NAPCAT_STATUS=$(get_napcat_status)

    # å®šä¹‰èœå•é¡¹ (æ·»åŠ  LOG)
    MENU_ITEMS=(
        "START"  "å¯åŠ¨ Napcat"
        "STOP"   "åœæ­¢ Napcat"
        "CONFIG" "é…ç½® Napcat"
        "UPDATE" "æ›´æ–° Napcat"
        "LOG"    "æŸ¥çœ‹æ—¥å¿—"   # æ–°å¢æ—¥å¿—é€‰é¡¹
    )

    # æ˜¾ç¤ºèœå• (è°ƒæ•´å°ºå¯¸å’Œé¡¹ç›®æ•°)
    # æ˜¾ç¤ºèœå•
    CHOICE=$(dialog --colors --clear --backtitle "Napcat Shell ä¸»èœå•" \
                    --title "ğŸŒŸ NapcatShell ğŸŒŸ" \
                    --ok-label "é€‰æ‹©" \
                    --cancel-label "é€€å‡º" \
                    --menu "\næ›´æ–°çŠ¶æ€: ${update_display_status}\nè¿è¡ŒçŠ¶æ€: ${NAPCAT_STATUS}\n\nè¯·é€‰æ‹©æ“ä½œ:" \
                    16 60 5 \
                    "${MENU_ITEMS[@]}" \
                    2>&1 >/dev/tty)

    exit_status=$?
    clear

    case $exit_status in
        0) # OK - ç”¨æˆ·é€‰æ‹©äº†æŸé¡¹
            case "$CHOICE" in
                "START")
                    if [[ -f "$BOOT_SCRIPT" ]] && [[ -x "$BOOT_SCRIPT" ]]; then
                        "$BOOT_SCRIPT" # æ‰§è¡Œå¯åŠ¨è„šæœ¬
                    else
                        dialog --colors --msgbox "${FG_RED}é”™è¯¯ï¼š${RESET}æ— æ³•æ‰¾åˆ°æˆ–æ‰§è¡Œå¯åŠ¨è„šæœ¬ '$BOOT_SCRIPT'ã€‚" 8 60
                    fi
                    ;;
                "STOP")
                    stop_napcat # è°ƒç”¨åœæ­¢å‡½æ•°
                    ;;
                "CONFIG")
                    if [[ -f "$CONFIG_SCRIPT" ]] && [[ -x "$CONFIG_SCRIPT" ]]; then
                        "$CONFIG_SCRIPT" # æ‰§è¡Œé…ç½®è„šæœ¬
                    else
                        dialog --colors --msgbox "${FG_RED}é”™è¯¯ï¼š${RESET}æ— æ³•æ‰¾åˆ°æˆ–æ‰§è¡Œé…ç½®è„šæœ¬ '$CONFIG_SCRIPT'ã€‚" 8 60
                    fi
                    ;;
                "UPDATE")
                    update_napcat # è°ƒç”¨æ›´æ–°å‡½æ•°
                    ;;
                "LOG") # æ–°å¢ LOG åˆ†æ”¯
                    view_log # è°ƒç”¨æŸ¥çœ‹æ—¥å¿—å‡½æ•°
                    ;;
                *)
                    dialog --colors --msgbox "æ— æ•ˆçš„é€‰æ‹©: '$CHOICE'" 6 40
                    ;;
            esac
            ;;
        1) # Cancel - ç”¨æˆ·é€‰æ‹©é€€å‡º
            echo -e "${ANSI_YELLOW}å·²é€€å‡º NapcatShellã€‚${ANSI_RESET}"
            break # é€€å‡ºä¸»å¾ªç¯
            ;;
        *) # å…¶ä»–æƒ…å†µ (ä¾‹å¦‚ ESC)
            echo -e "${ANSI_YELLOW}æ“ä½œå·²å–æ¶ˆæˆ–å‘ç”ŸæœªçŸ¥é”™è¯¯ (é€€å‡ºç : $exit_status)ã€‚${ANSI_RESET}"
            break # é€€å‡ºä¸»å¾ªç¯
            ;;
    esac
done

# æ¸…ç†å±å¹•å¹¶é€€å‡º
clear
exit 0
