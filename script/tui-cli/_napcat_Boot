#!/bin/bash


#  é…ç½®ç›®å½• 
TARGET_USER="$USER"
TARGET_USER_HOME="$HOME"

INSTALL_BASE_DIR="$TARGET_USER_HOME/Napcat"
RUN_DIR="$INSTALL_BASE_DIR/run"
LOG_DIR="$INSTALL_BASE_DIR/log"
QQ_EXECUTABLE="$INSTALL_BASE_DIR/opt/QQ/qq"
CONFIG_DIR="$INSTALL_BASE_DIR/opt/QQ/resources/app/app_launcher/napcat/config"


# è·å–å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œç”¨äºè°ƒç”¨ _napcat_Config
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
CONFIG_SCRIPT="$SCRIPT_DIR/_napcat_Config"




# æ£€æŸ¥ dialog æ˜¯å¦å®‰è£…
if ! command -v dialog &> /dev/null; then
    echo -e "${ANSI_RED}é”™è¯¯: éœ€è¦ 'dialog' å‘½ä»¤ï¼Œè¯·å…ˆå®‰è£…ã€‚${ANSI_RESET}" >&2
    echo "ä¾‹å¦‚: sudo apt update && sudo apt install dialog" >&2
    exit 1
fi

# æ£€æŸ¥ jq æ˜¯å¦å®‰è£… (ç”¨äºè¯»å–é…ç½®)
if ! command -v jq &> /dev/null; then
    echo -e "${ANSI_RED}é”™è¯¯: éœ€è¦ 'jq' å‘½ä»¤ï¼Œè¯·å…ˆå®‰è£…ã€‚${ANSI_RESET}" >&2
    echo "ä¾‹å¦‚: sudo apt update && sudo apt install jq" >&2
    exit 1
fi



#  ANSI é¢œè‰²å®šä¹‰ (ä½¿ç”¨ dialog --colors çš„ç®€åŒ–ä»£ç ) 
# æ³¨æ„ï¼šdialog --colors ä½¿ç”¨ \Z ä»£æ›¿ \e[ ï¼Œæ•°å­—ä»£è¡¨é¢œè‰²/å±æ€§
RESET='\Zn'      # é‡ç½®ä¸ºæ­£å¸¸
BOLD='\Zb'       # åˆ‡æ¢ç²—ä½“

# å‰æ™¯è‰²
FG_BLACK='\Z0'
FG_RED='\Z1'
FG_GREEN='\Z2'
FG_YELLOW='\Z3'
FG_BLUE='\Z4'
FG_MAGENTA='\Z5'
FG_CYAN='\Z6'
FG_WHITE='\Z7'
#  ANSI é¢œè‰²å®šä¹‰ (ç”¨äº echo -e) 
ANSI_RESET='\e[0m'
ANSI_BOLD='\e[1m'
ANSI_RED='\e[31m'
ANSI_GREEN='\e[32m'
ANSI_YELLOW='\e[33m'
ANSI_BLUE='\e[34m'
ANSI_MAGENTA='\e[35m'
ANSI_CYAN='\e[36m'
ANSI_WHITE='\e[37m'
#  å‡½æ•°å®šä¹‰ 

# å‡½æ•°ï¼šè·å–æœ‰æ•ˆçš„QQè´¦å·åˆ—è¡¨ (æ”¹ç¼–è‡ª _napcat_Config)
get_qq_accounts() {
    local accounts=()
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    if [[ ! -d "$CONFIG_DIR" ]]; then
        # ä¸ç›´æ¥æ˜¾ç¤º dialogï¼Œè€Œæ˜¯è¿”å›é”™è¯¯ï¼Œç”±ä¸»å¾ªç¯å¤„ç†
        echo -e "${FG_RED}ERROR: Config directory not found${RESET}" >&2 # æ·»åŠ é¢œè‰²
        return 1
    fi
    if [[ ! -d "$CONFIG_DIR" ]]; then
        # ä¸ç›´æ¥æ˜¾ç¤º dialogï¼Œè€Œæ˜¯è¿”å›é”™è¯¯ï¼Œç”±ä¸»å¾ªç¯å¤„ç†
        echo "ERROR: Config directory not found" >&2
        return 1
    fi
    shopt -s nullglob # å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ï¼Œåˆ™ä¸æŠ¥é”™
    for file in "$CONFIG_DIR"/onebot11_*.json; do
        local filename=$(basename "$file")
        # æå–æ–‡ä»¶åä¸­çš„æ•°å­—éƒ¨åˆ†
        if [[ "$filename" =~ onebot11_([0-9]+)\.json ]]; then
            local qq="${BASH_REMATCH[1]}"
            # æ£€æŸ¥QQå·é•¿åº¦æ˜¯å¦å¤§äº3 (åŸºæœ¬æœ‰æ•ˆæ€§æ£€æŸ¥)
            if [[ ${#qq} -gt 3 ]]; then
                accounts+=("$qq")
            fi
        fi
    done
    shopt -u nullglob
    # è¿”å›ç©ºæ ¼åˆ†éš”çš„åˆ—è¡¨
    echo "${accounts[@]}"
    return 0
}





_get_all_descendant_pids() {
    local ppid="$1"
    local children
    children=$(pgrep -P "$ppid" 2>/dev/null)
    for child in $children; do
        echo "$child"
        _get_all_descendant_pids "$child"
    done
}

_get_napcat_pid_and_account() {
    local candidate_pids
    local final_pids=()
    local qq_account=""
    local pid_file="$RUN_DIR/napcat.pid"

    # æ­¥éª¤ 1: å¹¿æ³›æ’’ç½‘ï¼Œæ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„å€™é€‰è¿›ç¨‹
    readarray -t candidate_pids < <(pgrep -u "$TARGET_USER" -f ".*/qq --no-sandbox -q [0-9]{4,}")

    # å¦‚æœä¸€ä¸ªå€™é€‰è€…éƒ½æ²¡æœ‰ï¼Œç›´æ¥è¿”å›
    if [[ ${#candidate_pids[@]} -eq 0 ]]; then
        [[ -f "$pid_file" ]] && rm -f "$pid_file"
        return 1 # æœªè¿è¡Œ
    fi

    # æ­¥éª¤ 2 & 3: æ™ºèƒ½è¿‡æ»¤ï¼Œåªä¿ç•™é¡¶å±‚çˆ¶è¿›ç¨‹
    for pid in "${candidate_pids[@]}"; do
        local ppid
        ppid=$(ps -o ppid= -p "$pid" | tr -d ' ') # è·å–çˆ¶è¿›ç¨‹IDå¹¶å»é™¤ç©ºæ ¼
        
        local is_child=false
        # æ£€æŸ¥è¿™ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹(ppid)æ˜¯å¦ä¹Ÿæ˜¯ä¸€ä¸ªå€™é€‰è€…
        for other_pid in "${candidate_pids[@]}"; do
            if [[ "$ppid" == "$other_pid" ]]; then
                is_child=true
                break
            fi
        done

        # å¦‚æœå®ƒä¸æ˜¯ä»»ä½•å…¶ä»–å€™é€‰è€…çš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªé¡¶å±‚çˆ¶è¿›ç¨‹
        if ! $is_child; then
            final_pids+=("$pid")
        fi
    done

    # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¤šä¸ªç‹¬ç«‹çš„é¡¶å±‚å®ä¾‹
    if [[ ${#final_pids[@]} -gt 1 ]]; then
        echo -e "${ANSI_YELLOW}è­¦å‘Š: æ£€æµ‹åˆ° ${#final_pids[@]} ä¸ªç‹¬ç«‹çš„ Napcat å®ä¾‹ã€‚å°†è‡ªåŠ¨æ¸…ç†å¤šä½™è¿›ç¨‹ï¼Œåªä¿ç•™ä¸€ä¸ª...${ANSI_RESET}" >&2
        
        local pids_to_kill=("${final_pids[@]:1}")
        for pid_to_kill in "${pids_to_kill[@]}"; do
            echo "æ­£åœ¨ç»ˆæ­¢å¤šä½™çš„çˆ¶è¿›ç¨‹ PID: $pid_to_kill..." >&2
            local all_pids_to_kill=("$pid_to_kill" $(_get_all_descendant_pids "$pid_to_kill"))
            kill "${all_pids_to_kill[@]}" 2>/dev/null && sleep 0.5
            if kill -0 "$pid_to_kill" 2>/dev/null; then
                kill -9 "${all_pids_to_kill[@]}" 2>/dev/null
            fi
        done
        final_pids=("${final_pids[0]}")
    fi

    if [[ ${#final_pids[@]} -eq 0 ]]; then
        [[ -f "$pid_file" ]] && rm -f "$pid_file"
        return 1 # æœªè¿è¡Œ
    fi

    local pid="${final_pids[0]}"
    local cmdline
    cmdline=$(ps -o cmd= -p "$pid" 2>/dev/null)

    if [[ "$cmdline" =~ --no-sandbox[[:space:]]+-q[[:space:]]+([0-9]{4,}) ]]; then
        qq_account="${BASH_REMATCH[1]}"
        echo "$pid" > "$pid_file"
        echo "$qq_account"
        return 0 # è¿è¡Œä¸­
    else
        echo "$pid"
        return 2 # çŠ¶æ€æœªçŸ¥
    fi
}


get_napcat_status() {
    local status_code
    local output

    # è°ƒç”¨å†…éƒ¨å‡½æ•°ï¼Œæ•è·è¾“å‡ºå’ŒçŠ¶æ€ç 
    output=$(_get_napcat_pid_and_account)
    status_code=$?

    case $status_code in
        0) # è¿è¡Œä¸­
            local qq_account="$output"
            echo -e "${FG_GREEN}è¿è¡Œä¸­ğŸ˜‹ - ${BOLD}$qq_account${RESET}"
            ;;
        1) # æœªè¿è¡Œ
            echo -e "${FG_YELLOW}æœªè¿è¡ŒğŸ˜´${RESET}"
            ;;
        2) # çŠ¶æ€æœªçŸ¥
            local pid="$output"
            echo -e "${FG_RED}çŠ¶æ€æœªçŸ¥ğŸ¤” (PID: ${BOLD}$pid${RESET})${RESET}"
            ;;
        *) # å…¶ä»–æœªçŸ¥é”™è¯¯
             echo -e "${FG_RED}æ£€æŸ¥çŠ¶æ€å‡ºé”™${RESET}"
             ;;
    esac
}

# å‡½æ•°ï¼šæ‰§è¡Œç™»å½•
start_napcat_login() {
    local qq_account=$1
    local pid_file="$RUN_DIR/napcat.pid"
    local log_file="$LOG_DIR/napcat_${qq_account}.log"
    local config_file="$CONFIG_DIR/onebot11_${qq_account}.json"

    mkdir -p "$RUN_DIR" "$LOG_DIR"

    # 1. æ£€æŸ¥å¹¶æ¸…ç†æ‰€æœ‰ç°æœ‰è¿›ç¨‹ (ä½¿ç”¨æ™ºèƒ½è¿‡æ»¤çš„å¥å£®æ–¹æ³•)
    local candidate_pids
    local final_pids=()
    readarray -t candidate_pids < <(pgrep -u "$TARGET_USER" -f ".*/qq --no-sandbox -q [0-9]{4,}")

    if [[ ${#candidate_pids[@]} -gt 0 ]]; then
        for pid in "${candidate_pids[@]}"; do
            local ppid=$(ps -o ppid= -p "$pid" | tr -d ' ')
            local is_child=false
            for other_pid in "${candidate_pids[@]}"; do
                if [[ "$ppid" == "$other_pid" ]]; then
                    is_child=true
                    break
                fi
            done
            if ! $is_child; then
                final_pids+=("$pid")
            fi
        done
    fi

    if [[ ${#final_pids[@]} -gt 0 ]]; then
        dialog --colors --title "è¿›ç¨‹å†²çª" --yesno "æ£€æµ‹åˆ° Napcat å®ä¾‹ (PIDs: ${BOLD}${final_pids[*]}${RESET}) æ­£åœ¨è¿è¡Œã€‚\n\næ˜¯å¦ç»ˆæ­¢æ‰€æœ‰ç°æœ‰è¿›ç¨‹å¹¶ç»§ç»­å¯åŠ¨ï¼Ÿ" 10 70 2>&1 >/dev/tty
        local choice=$?
        clear
        if [[ $choice -eq 0 ]]; then # Yes - ç»ˆæ­¢è¿›ç¨‹
            echo -e "${ANSI_YELLOW}æ­£åœ¨å°è¯•ç»ˆæ­¢æ‰€æœ‰ç°æœ‰è¿›ç¨‹ (PIDs: ${ANSI_BOLD}${final_pids[*]}${ANSI_RESET})${ANSI_YELLOW}...${ANSI_RESET}"
            
            local all_stopped=true
            for pid in "${final_pids[@]}"; do
                local all_pids_to_kill=("$pid" $(_get_all_descendant_pids "$pid"))
                kill "${all_pids_to_kill[@]}" 2>/dev/null
            done
            sleep 2

            for pid in "${final_pids[@]}"; do
                if kill -0 "$pid" 2>/dev/null; then
                    echo -e "${ANSI_RED}æ— æ³•æ­£å¸¸ç»ˆæ­¢è¿›ç¨‹ (PID: $pid)ï¼Œå°è¯•å¼ºåˆ¶ç»ˆæ­¢...${ANSI_RESET}"
                    local all_pids_to_kill=("$pid" $(_get_all_descendant_pids "$pid"))
                    kill -9 "${all_pids_to_kill[@]}" 2>/dev/null
                    sleep 1
                fi
                if kill -0 "$pid" 2>/dev/null; then
                    all_stopped=false
                fi
            done

            if $all_stopped; then
                echo -e "${ANSI_GREEN}æ‰€æœ‰ç°æœ‰è¿›ç¨‹å·²ç»ˆæ­¢ã€‚${ANSI_RESET}"
                rm -f "$pid_file"
            else
                dialog --colors --msgbox "é”™è¯¯ï¼šæ— æ³•ç»ˆæ­¢æ‰€æœ‰ç°æœ‰ Napcat è¿›ç¨‹ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶ç»ˆæ­¢ã€‚" 8 65
                return 1 # æ— æ³•ç»§ç»­
            fi
        else # No - å–æ¶ˆ
            dialog --colors --msgbox "å¯åŠ¨å·²å–æ¶ˆã€‚" 6 40
            return 1
        fi
    else
        [[ -f "$pid_file" ]] && rm -f "$pid_file"
    fi

    # 2. æ£€æŸ¥ç½‘ç»œæœåŠ¡é…ç½®
    local has_network_service=false
    if [[ -f "$config_file" ]] && [[ -r "$config_file" ]]; then
        # ä½¿ç”¨ jq æ£€æŸ¥ network ä¸‹çš„æ•°ç»„æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªéç©º
        local jq_check_result=$(jq '
            (.network // null) as $net |
            if $net == null then
                false
            else
                ( ($net.httpServers // []) | length > 0 ) or
                ( ($net.httpClients // []) | length > 0 ) or
                ( ($net.websocketServers // []) | length > 0 ) or
                ( ($net.websocketClients // []) | length > 0 )
            end
        ' "$config_file" 2>/dev/null)

        if [[ "$jq_check_result" == "true" ]]; then
            has_network_service=true
        fi
    fi

    if ! $has_network_service; then
        dialog --colors --title "ç½‘ç»œæœåŠ¡æœªé…ç½®" --yesno "è­¦å‘Šï¼šè´¦å· ${FG_CYAN}${BOLD}$qq_account${RESET} æœªå¯ç”¨ä»»ä½•ç½‘ç»œæœåŠ¡ (HTTP/WebSocket æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯)ã€‚\n\nè¿™å¯èƒ½å¯¼è‡´æœºå™¨äººæ— æ³•ä¸å¤–éƒ¨åº”ç”¨äº¤äº’ã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­å¯åŠ¨ Napcatï¼Ÿ" 12 70 2>&1 >/dev/tty # åŠ ç²—è´¦å·
        local choice=$?
        clear
        if [[ $choice -ne 0 ]]; then # No - å–æ¶ˆ
            dialog --colors --msgbox "å¯åŠ¨å·²å–æ¶ˆã€‚" 6 40
            return 1
        fi
    fi

    # 3. å¯åŠ¨ Napcat
    clear
    echo -e "${ANSI_GREEN}æ­£åœ¨å°è¯•ä¸ºè´¦å· ${ANSI_BOLD}$qq_account${ANSI_RESET}${ANSI_GREEN} (ä»¥ç”¨æˆ· ${TARGET_USER} èº«ä»½) å¯åŠ¨ Napcat...${ANSI_RESET}"
    echo "æ—¥å¿—æ–‡ä»¶: $log_file"
    

    # æ„å»ºéœ€è¦ä»¥æ™®é€šç”¨æˆ·èº«ä»½æ‰§è¡Œçš„å‘½ä»¤
    local user_command="xvfb-run -a '$QQ_EXECUTABLE' --no-sandbox -q '$qq_account'"

    # ç›´æ¥ä»¥å½“å‰ç”¨æˆ·èº«ä»½åœ¨åå°è¿è¡Œ
    bash -c "$user_command" > "$log_file" 2>&1 &
    NAPCAT_PID=$!

    # æ£€æŸ¥åå°å‘½ä»¤æ˜¯å¦æˆåŠŸå¯åŠ¨ (PID æ˜¯å¦å¤§äº 0)
    if [[ "$NAPCAT_PID" -le 0 ]]; then
        dialog --colors --msgbox "é”™è¯¯ï¼šå¯åŠ¨ Napcat å¤±è´¥ï¼Œæœªèƒ½è·å–è¿›ç¨‹ PIDã€‚" 8 60
        return 1
    fi

    echo "Napcat è¿›ç¨‹ PID: $NAPCAT_PID"

    # å°† PID å†™å…¥æ–‡ä»¶
    echo "$NAPCAT_PID" > "$pid_file"
    if [[ $? -ne 0 ]]; then
         dialog --colors --msgbox "${FG_YELLOW}è­¦å‘Šï¼šæ— æ³•å°† PID å†™å…¥ '${BOLD}$pid_file${RESET}${FG_YELLOW}'ã€‚è¯·æ£€æŸ¥æƒé™ã€‚${RESET}" 8 65 # åŠ ç²—æ–‡ä»¶åï¼Œè°ƒæ•´å®½åº¦
         # ä¸ä¸€å®šéœ€è¦é€€å‡ºï¼Œä½†è®°å½•ä¸€ä¸‹
    fi
    echo -e "${ANSI_GREEN}Napcat æ­£åœ¨åå°å¯åŠ¨... æ­£åœ¨ç›‘æ§æ—¥å¿—...${ANSI_RESET}"

    # 4. ç›‘æ§æ—¥å¿—æ–‡ä»¶
    local timeout=15 # åˆå§‹è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    local qr_timeout=60 # æ‰«ç åçš„ç™»å½•è¶…æ—¶æ—¶é—´
    local found_login=false
    local tailbox_pid=""

    # ç­‰å¾…æ—¥å¿—æ–‡ä»¶ç”Ÿæˆ
    local wait_log_count=5
    while [[ ! -f "$log_file" ]] && [[ $wait_log_count -gt 0 ]]; do
        sleep 1
        ((wait_log_count--))
    done

    if [[ ! -f "$log_file" ]]; then
        dialog --colors --msgbox "${FG_RED}é”™è¯¯ï¼šç­‰å¾…æ—¥å¿—æ–‡ä»¶ '${BOLD}$log_file${RESET}${FG_RED}' ç”Ÿæˆè¶…æ—¶ã€‚${RESET}" 8 65 # åŠ ç²—æ–‡ä»¶åï¼Œè°ƒæ•´å®½åº¦
        return 1
    fi

    while [[ $timeout -gt 0 ]]; do

        # æ£€æŸ¥æ˜¯å¦å¤šè´¦æˆ·ç™»å½•
        if grep -q "æ— æ³•é‡å¤ç™»å½•" "$log_file"; then
            dialog --colors --title "ç™»å½•å†²çª" --msgbox "${FG_RED}ç¦æ­¢å¤šè´¦æˆ·: æ‚¨å·²ç»ç™»å½•æˆ–è€…å¦å¤–ä¸€ä¸ª Napcat æœªå…³é—­ã€‚\nè¯·æ£€æŸ¥å¹¶å…³é—­å…¶ä»– Napcat å®ä¾‹åé‡è¯•ã€‚${RESET}" 10 70
            # å°è¯•æ¸…ç†å½“å‰å¯åŠ¨çš„è¿›ç¨‹å’ŒPIDæ–‡ä»¶
            if [[ -n "$NAPCAT_PID" ]] && kill -0 "$NAPCAT_PID" &>/dev/null; then
                kill "$NAPCAT_PID" &>/dev/null
                sleep 1
                kill -9 "$NAPCAT_PID" &>/dev/null # å¼ºåˆ¶
            fi
            rm -f "$pid_file"
            return 1 # è¿”å›é”™è¯¯ï¼Œç»ˆæ­¢å¯åŠ¨
        fi

        # æ£€æŸ¥ç™»å½•æˆåŠŸå…³é”®å­—
        if grep -q "é…ç½®åŠ è½½" "$log_file"; then
            dialog --colors --title "ç™»å½•æˆåŠŸ" --infobox "Napcat (è´¦å·: ${BOLD}$qq_account${RESET}) å·²æˆåŠŸç™»å½•ï¼" 5 55 # åŠ ç²—è´¦å·ï¼Œè°ƒæ•´å®½åº¦
            sleep 1 # æ˜¾ç¤ºä¿¡æ¯ä¸€ä¼šå„¿
            found_login=true
            break
        fi

        # æ£€æŸ¥äºŒç»´ç å…³é”®å­—
        if grep -q "äºŒç»´ç " "$log_file"; then
            clear # æ¸…ç†å±å¹•ï¼Œå‡†å¤‡æ˜¾ç¤ºæç¤º
            echo -e "${ANSI_YELLOW}æ£€æµ‹åˆ°ç™»å½•äºŒç»´ç ï¼Œè¯·åœ¨ Napcat æ—¥å¿—ä¸­æŸ¥çœ‹å¹¶æ‰«æï¼š${ANSI_RESET}"
            echo -e "$$log_file" # åŠ ç²—æ—¥å¿—æ–‡ä»¶å
            echo -e "${ANSI_YELLOW}æ³¨æ„ï¼šå³å°†æ˜¾ç¤ºçš„æ˜¯æ—¥å¿—å¿«ç…§ï¼ŒäºŒç»´ç å¯èƒ½ä¼šåˆ·æ–°ã€‚${ANSI_RESET}"
            echo -e "${ANSI_YELLOW}å¦‚æœæ‰«æå¤±è´¥ï¼Œè¯·ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–æœ€æ–°äºŒç»´ç ã€‚${ANSI_RESET}"
            echo -e "${ANSI_YELLOW}æ­£åœ¨åå°ç›‘æ§ç™»å½•çŠ¶æ€ (${ANSI_BOLD}${qr_timeout}${ANSI_RESET}${ANSI_YELLOW}ç§’)...${ANSI_RESET}" # åŠ ç²—è¶…æ—¶æ—¶é—´
            sleep 1
            cat "$log_file"
            echo -e "${ANSI_YELLOW}æ­£åœ¨åå°ç›‘æ§ç™»å½•çŠ¶æ€ (${qr_timeout}ç§’)...${ANSI_RESET}"
            # tailbox_pid ä¸å†éœ€è¦
            tailbox_pid=""

            # å¼€å§‹ç›‘æ§æ‰«ç åçš„ç™»å½•
            echo -e "${ANSI_YELLOW}æ£€æµ‹åˆ°äºŒç»´ç ï¼Œè¯·æ‰«æã€‚æ­£åœ¨åå°ç›‘æ§ç™»å½•çŠ¶æ€ (${qr_timeout}ç§’)...${ANSI_RESET}"
            local qr_wait=$qr_timeout
            while [[ $qr_wait -gt 0 ]]; do
                 if grep -q "é…ç½®åŠ è½½" "$log_file"; then
                     # å…³é—­ tailbox
                     if [[ -n "$tailbox_pid" ]] && kill -0 "$tailbox_pid" 2>/dev/null; then
                         kill "$tailbox_pid" 2>/dev/null
                     fi
                     dialog --colors --title "ç™»å½•æˆåŠŸ" --infobox "Napcat (è´¦å·: $qq_account) å·²æˆåŠŸç™»å½•ï¼" 5 50
                     sleep 2
                     found_login=true
                     break 2 # è·³å‡ºå†…å¤–ä¸¤å±‚å¾ªç¯
                 fi
                 sleep 1
                 ((qr_wait--))
            done

            # å¦‚æœæ˜¯å› ä¸ºè¶…æ—¶é€€å‡ºå†…å±‚å¾ªç¯
            if ! $found_login; then
                 # å…³é—­ tailbox
                 if [[ -n "$tailbox_pid" ]] && kill -0 "$tailbox_pid" 2>/dev/null; then
                     kill "$tailbox_pid" 2>/dev/null
                 fi
                 dialog --colors --title "ç™»å½•è¶…æ—¶" --msgbox "${FG_YELLOW}æ‰«æäºŒç»´ç åç™»å½•è¶…æ—¶æˆ–å¤±è´¥ã€‚\nè¯·æ£€æŸ¥æ—¥å¿—: ${BOLD}$log_file${RESET}" 8 65 # åŠ ç²—æ–‡ä»¶åï¼Œè°ƒæ•´å®½åº¦
                 # è¿™é‡Œä¸ returnï¼Œè®©å¤–å±‚å¾ªç¯ä¹Ÿç»“æŸ
            fi
            break # è·³å‡ºå¤–å±‚å¾ªç¯ (æ— è®ºå†…å±‚æ˜¯å¦æˆåŠŸ)
        fi

        sleep 1
        ((timeout--))
    done

    # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ tailbox è¿›ç¨‹
    if [[ -n "$tailbox_pid" ]] && kill -0 "$tailbox_pid" 2>/dev/null; then
        kill "$tailbox_pid" 2>/dev/null
    fi

    # å¦‚æœæœ€ç»ˆæ²¡æœ‰ç™»å½•æˆåŠŸ
    if ! $found_login; then
        dialog --colors --title "çŠ¶æ€æœªçŸ¥" --msgbox "${FG_YELLOW}Napcat çŠ¶æ€å¼‚å¸¸æˆ–è¶…æ—¶ã€‚\næœªåœ¨æ—¥å¿—ä¸­æ£€æµ‹åˆ°æ˜ç¡®çš„ç™»å½•æˆåŠŸæˆ–äºŒç»´ç ä¿¡æ¯ã€‚\nè¯·æ‰‹åŠ¨æ£€æŸ¥æ—¥å¿—: ${BOLD}$log_file${RESET}" 10 70 # åŠ ç²—æ–‡ä»¶å
        return 1 # è¿”å›é”™è¯¯çŠ¶æ€
    fi

    return 0 # æˆåŠŸå®Œæˆï¼ˆæˆ–è‡³å°‘å¯åŠ¨å¹¶ç›‘æ§äº†ä¸€æ®µæ—¶é—´ï¼‰
}

#  ä¸»é€»è¾‘ 

while true; do
    NAPCAT_STATUS=$(get_napcat_status)
    ACCOUNTS_LIST_STR=$(get_qq_accounts)
    # æ£€æŸ¥ get_qq_accounts æ˜¯å¦è¿”å›é”™è¯¯ä¿¡æ¯
    if [[ "$ACCOUNTS_LIST_STR" == "ERROR:"* ]]; then
         dialog --colors --msgbox "é”™è¯¯ï¼šæ— æ³•è·å–è´¦å·åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥é…ç½®ç›®å½• '$CONFIG_DIR'ã€‚" 8 60
         exit 1
    fi
    ACCOUNTS_LIST=($ACCOUNTS_LIST_STR) # å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°ç»„

    MENU_ITEMS=()
    CONFIG_TAG="GOTO_CONFIG" # å®šä¹‰ä¸€ä¸ªæ¸…æ™°çš„ tag ç”¨äºé…ç½®é€‰é¡¹

    if [[ ${#ACCOUNTS_LIST[@]} -eq 0 ]]; then
        # æ²¡æœ‰æ‰¾åˆ°è´¦æˆ·ï¼Œåªæ˜¾ç¤ºé…ç½®é€‰é¡¹
        MENU_ITEMS+=("$CONFIG_TAG" "${FG_YELLOW}æ²¡æœ‰ä»»ä½•å·²é…ç½®çš„QQè´¦æˆ·ï¼Œè¯·å‰å¾€é…ç½®æ·»åŠ ${RESET}")
    else
        # æ‰¾åˆ°äº†è´¦æˆ·ï¼Œåˆ—å‡ºè´¦æˆ·ä½œä¸ºå¯åŠ¨é€‰é¡¹
        # ä½¿ç”¨ QQ å·æœ¬èº«ä½œä¸º tag
        for acc in "${ACCOUNTS_LIST[@]}"; do
            MENU_ITEMS+=("$acc" "å¯åŠ¨è´¦å·: ${FG_CYAN}$acc${RESET}")
        done
        # æ·»åŠ é…ç½®é€‰é¡¹
        MENU_ITEMS+=("$CONFIG_TAG" "é…ç½® Napcat (è´¦å·/æœåŠ¡)")
    fi

    # è®¡ç®—å®é™…çš„èœå•é¡¹æ•°é‡ (è´¦å·æ•° + æ·»åŠ é¡¹)
    num_entries=$(( ${#ACCOUNTS_LIST[@]} + 1 )) # ç§»é™¤ local

    # è®¾ç½®åˆ—è¡¨çš„æœŸæœ›æ˜¾ç¤ºé«˜åº¦ (ä¾‹å¦‚ï¼Œæœ€å¤šæ˜¾ç¤º 8 è¡Œ)
    list_height=$num_entries # ç§»é™¤ local
    [[ $list_height -gt 8 ]] && list_height=8
    [[ $list_height -lt 1 ]] && list_height=1 # ç¡®ä¿è‡³å°‘ä¸º1

    # è®¡ç®—å¯¹è¯æ¡†çš„æ€»é«˜åº¦ï¼šåˆ—è¡¨é«˜åº¦ + é¢å¤–ç©ºé—´ (çº¦ 7 è¡Œ)
    menu_height=$(( list_height + 7 )) # ç§»é™¤ local
    [[ $menu_height -lt 10 ]] && menu_height=10 # ç¡®ä¿æœ€å°æ€»é«˜åº¦

    CHOICE=$(dialog --colors --clear --backtitle "Napcat å¯åŠ¨å™¨" \
                    --title "å¯åŠ¨ Napcat" \
                    --ok-label "é€‰æ‹©" \
                    --cancel-label "é€€å‡º" \
                    --extra-button --extra-label "åˆ·æ–°çŠ¶æ€" \
                    --menu "çŠ¶æ€ï¼š${NAPCAT_STATUS}\nè¯·é€‰æ‹©æ“ä½œ:" \
                    "$menu_height" 70 "$list_height" \
                    "${MENU_ITEMS[@]}" \
                    2>&1 >/dev/tty)

    exit_status=$?
    clear

    case $exit_status in
        0) 
            case "$CHOICE" in
                "$CONFIG_TAG") 
                    # æ£€æŸ¥ _napcat_Config æ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œ
                    if [[ -f "$CONFIG_SCRIPT" ]] && [[ -x "$CONFIG_SCRIPT" ]]; then
                        "$CONFIG_SCRIPT" # æ‰§è¡Œé…ç½®è„šæœ¬
                    else
                        dialog --colors --msgbox "é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°æˆ–æ‰§è¡Œé…ç½®è„šæœ¬ '$CONFIG_SCRIPT'ã€‚" 8 60
                    fi
                    ;;
                *) # å‡å®šç”¨æˆ·é€‰æ‹©äº†ä¸€ä¸ª QQ è´¦å·
                    # æ£€æŸ¥é€‰æ‹©çš„æ˜¯å¦æ˜¯æœ‰æ•ˆçš„è´¦å· (ä» ACCOUNTS_LIST éªŒè¯)
                    is_valid_account=false
                    for acc in "${ACCOUNTS_LIST[@]}"; do
                        if [[ "$CHOICE" == "$acc" ]]; then
                            is_valid_account=true
                            break
                        fi
                    done

                    if $is_valid_account; then
                        # ç¡®è®¤æ˜¯æœ‰æ•ˆè´¦å·åï¼Œè°ƒç”¨å¯åŠ¨å‡½æ•°
                        start_napcat_login "$CHOICE"
                    else
                        # å¦‚æœ CHOICE ä¸æ˜¯é…ç½® TAG ä¹Ÿä¸æ˜¯åˆ—è¡¨ä¸­çš„æœ‰æ•ˆè´¦å·
                        dialog --colors --msgbox "å‡ºç°æ„å¤–é”™è¯¯ï¼Œæ— æ•ˆçš„é€‰æ‹©: '$CHOICE'" 6 40
                    fi
                    ;;
            esac
            ;;
        1) 
            echo "å·²é€€å‡º Napcat å¯åŠ¨å™¨ã€‚"
            break # é€€å‡ºä¸»å¾ªç¯
            ;;
        3) 
            continue
            ;;
        *) 
            echo "æ“ä½œå·²å–æ¶ˆæˆ–å‘ç”ŸæœªçŸ¥é”™è¯¯ (é€€å‡ºç : $exit_status)ã€‚"
            break # é€€å‡ºä¸»å¾ªç¯
            ;;
    esac
done

# æ¸…ç†å±å¹•
clear